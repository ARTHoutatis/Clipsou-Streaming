<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Admin â€“ Clipsou Streaming</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" href="../favicon.webp" type="image/webp">
  <link rel="stylesheet" href="admin.css?v=20250910">
</head>
<body>
  <main class="container" id="app" hidden>
    <h1>Clipsou Streaming â€“ Admin</h1>

    <section class="auth">
      <p class="muted">AccÃ¨s restreint. Votre session admin est active.</p>
      <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between">
        <div style="display:flex;gap:10px;align-items:center">
          <button id="logoutBtn" type="button" class="btn">Se dÃ©connecter</button>
          <button id="googleLinkBtn" class="btn secondary" type="button" onclick="window.__fbSignIn && window.__fbSignIn()">Se connecter avec Google</button>
          <span id="googleStatusTop" class="small muted"></span>
          <span id="authNoticeTop" style="display:none;padding:2px 8px;border-radius:12px;background:#16a34a;color:#fff;font-size:12px;">ConnectÃ©</span>
        </div>
        <img id="googleAvatarTop" alt="avatar" style="width:32px;height:32px;border-radius:50%;object-fit:cover;display:none"/>
      </div>
    </section>

    <section class="form-section">
      <h2 style="display:flex; align-items:center; gap:8px;">
        Stockage images (Cloudinary)
        <button type="button" id="cldLockBtn" class="btn secondary lock-btn" title="Verrouiller/dÃ©verrouiller la configuration">ðŸ”’</button>
      </h2>
      <p class="muted small">Saisissez votre <strong>Cloud name</strong> et votre <strong>Upload preset</strong> (unsigned) pour activer lâ€™upload en ligne. Ces rÃ©glages sont stockÃ©s dans votre navigateur.</p>
      <form id="cloudinaryForm">
        <div class="grid">
          <label>
            <span>Cloud name</span>
            <input type="text" id="cldCloudName" placeholder="ex: clipsoucloud" readonly>
          </label>
          <label>
            <span>Upload preset (unsigned)</span>
            <input type="text" id="cldUploadPreset" placeholder="ex: clipsou_unsigned" readonly>
          </label>
          <label>
            <span>Dossier (optionnel)</span>
            <input type="text" id="cldFolder" placeholder="ex: clipsou" readonly>
          </label>
        </div>
        <div class="actions" id="cldActionsRow">
          <button type="button" id="cldSaveBtn" class="btn" disabled>Enregistrer la configuration</button>
          <button type="button" id="cldClearBtn" class="btn secondary" disabled>RÃ©initialiser</button>
        </div>
        <p id="cldStatus" class="muted small"></p>
      </form>
    </section>

    <section class="form-section">
      <h2>Ajouter / Modifier un contenu</h2>
      <form id="contentForm">
        <input type="hidden" name="id" id="id">
        <input type="hidden" name="requestId" id="requestId">

        <div class="grid">
          <label>
            <span>Titre</span>
            <input type="text" id="title" required>
          </label>
          <label>
            <span>Type</span>
            <select id="type" required>
              <option value="film">Film</option>
              <option value="sÃ©rie">SÃ©rie</option>
              <option value="trailer">Trailer</option>
            </select>
          </label>
          <label>
            <span>Note (/5)</span>
            <input type="number" id="rating" step="0.5" min="0" max="5">
          </label>
        </div>

        <div class="grid">
          <label>
            <span>Genre 1</span>
            <input type="text" id="genre1" list="genresDatalist" required>
          </label>
          <label>
            <span>Genre 2</span>
            <input type="text" id="genre2" list="genresDatalist" required>
          </label>
          <label>
            <span>Genre 3</span>
            <input type="text" id="genre3" list="genresDatalist" required>
          </label>
        </div>

        <label>
          <span>Description</span>
          <textarea id="description" rows="4" required></textarea>
        </label>

        <div class="grid">
          <label>
            <span>Image carte (portrait 9/12)</span>
            <input type="hidden" id="portraitImage">
            <div class="actions">
              <label class="btn file-label">
                Importer image
                <input type="file" id="portraitFileInput" accept="image/*" hidden>
              </label>
              <button type="button" id="portraitClearBtn" class="btn secondary">Effacer</button>
            </div>
            <img id="portraitPreview" class="img-preview" alt="AperÃ§u portrait" hidden>
          </label>
          <label>
            <span>Image fiche (paysage 16/9)</span>
            <input type="hidden" id="landscapeImage">
            <div class="actions">
              <label class="btn file-label">
                Importer image
                <input type="file" id="landscapeFileInput" accept="image/*" hidden>
              </label>
              <button type="button" id="landscapeClearBtn" class="btn secondary">Effacer</button>
            </div>
            <img id="landscapePreview" class="img-preview" alt="AperÃ§u paysage" hidden>
          </label>
          <label>
            <span>Lien YouTube</span>
            <input type="url" id="watchUrl" placeholder="https://www.youtube.com/..." required>
          </label>
          <label>
            <span>Ã‰tiquette studio (image)</span>
            <input type="hidden" id="studioBadge">
            <div class="actions">
              <label class="btn file-label">
                Importer image
                <input type="file" id="studioBadgeFileInput" accept="image/*" hidden>
              </label>
              <button type="button" id="studioBadgeClearBtn" class="btn secondary">Effacer</button>
            </div>
            <img id="studioBadgePreview" class="img-preview" alt="AperÃ§u Ã©tiquette studio" hidden>
          </label>
        </div>

        <fieldset>
          <legend>Acteurs & Doubleurs</legend>
          <div id="actorsList" class="actors-list"></div>
          <div class="actor-row">
            <input type="text" id="actorName" placeholder="Nom" list="actorNamesDatalist">
            <input type="text" id="actorRole" placeholder="RÃ´le">
            <label class="btn file-label" title="Photo de profil (optionnel)">
              Photo
              <input type="file" id="actorPhotoFile" accept="image/*" hidden>
            </label>
            <img id="actorPhotoPreview" class="img-preview small" alt="AperÃ§u acteur" hidden>
            <button type="button" id="addActorBtn" class="btn secondary">Ajouter</button>
          </div>
        </fieldset>

        <div class="actions">
          <button type="submit" class="btn">Enregistrer la requÃªte</button>
          <button type="button" id="resetBtn" class="btn secondary">Nouveau</button>
        </div>
      </form>
      <datalist id="genresDatalist"></datalist>
      <datalist id="actorNamesDatalist"></datalist>
    </section>

    <section class="requests">
      <h2>RequÃªtes d'ajout</h2>
      <table class="table" id="requestsTable" aria-describedby="requestsHelp">
        <thead>
          <tr>
            <th>Titre</th>
            <th>Type</th>
            <th>Genres</th>
            <th>Note</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p id="requestsHelp" class="muted">Approuvez une requÃªte pour la publier. Vous pouvez modifier ou supprimer Ã  tout moment.</p>
    </section>
  </main>

  <div id="login" class="login">
    <h1>Admin â€“ Connexion</h1>
    <p class="muted">Entrez le mot de passe admin pour accÃ©der Ã  lâ€™interface.</p>
    <input id="passwordInput" type="password" placeholder="Mot de passe" value="20Blabla30">
    <div style="display:flex; gap:12px; justify-content:center; align-items:center; margin:8px 0;">
      <label style="display:flex; gap:6px; align-items:center;">
        <input id="showPwd" type="checkbox">
        <span>Afficher le mot de passe</span>
      </label>
    </div>
    <button id="loginBtn" class="btn" type="button" onclick="(function(){
      try { if (window.__doLogin) return window.__doLogin(); } catch(e){}
      try {
        var pwdEl = document.getElementById('passwordInput');
        var app = document.getElementById('app');
        var login = document.getElementById('login');
        var pwd = (pwdEl && pwdEl.value) || '';
        if (pwd === '20Blabla30') {
          try { sessionStorage.setItem('clipsou_admin_session_v1','1'); localStorage.setItem('clipsou_admin_remember_v1','1'); } catch(e){}
          if (login) login.hidden = true;
          if (app) app.hidden = false;
        } else { alert('Mot de passe incorrect.'); }
      } catch(e){}
    })()">Se connecter</button>

    
  </div>

  <!-- Google Identity Services for Sign in With Google -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyAwnc0bRBdspspUA3Ksuy-rVWGA7nAiRoI",
      authDomain: "clipsoustreaming-52bc4.firebaseapp.com",
      projectId: "clipsoustreaming-52bc4",
      storageBucket: "clipsoustreaming-52bc4.firebasestorage.app",
      messagingSenderId: "115181244019",
      appId: "1:115181244019:web:850162fc7f6f1a0f3ea406",
      measurementId: "G-SKP5SSYV97"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    try { const analytics = getAnalytics(app); } catch {}
    // Expose Auth globally for admin.js
    const auth = getAuth(app);
    const db = getFirestore(app);
    window.__fbAuth = auth;
    window.__fbDB = db;
    window.__GoogleAuthProvider = GoogleAuthProvider;
    window.__signInWithPopup = signInWithPopup;
    window.__onAuthStateChanged = onAuthStateChanged;
    window.__fbSignOut = signOut;
    // Firestore helpers
    window.__fsDoc = doc;
    window.__fsGetDoc = getDoc;
    window.__fsSetDoc = setDoc;
    window.__fsServerTs = serverTimestamp;
    // Provide a global sign-in function used by the inline onclick fallback
    window.__fbSignIn = async function(){
      try {
        if (window.__signingIn) return; // prevent concurrent popups
        window.__signingIn = true;
        const provider = new GoogleAuthProvider();
        // Mobile browsers can block popups -> use redirect
        const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        if (isMobile) {
          await signInWithRedirect(auth, provider);
          return; // flow continues after redirect
        }
        await signInWithPopup(auth, provider);
      } catch(e) {
        console.error('Firebase sign-in failed', e);
        alert('Connexion Google impossible. VÃ©rifiez que les popups ne sont pas bloquÃ©es.');
      }
      finally { window.__signingIn = false; }
    };

    // Handle redirect result if any (mobile)
    (async () => {
      try {
        const res = await getRedirectResult(auth);
        if (res && res.user) {
          console.log('Signed in via redirect');
        }
      } catch(e) { /* ignore */ }
    })();
  </script>
  <script src="admin.js" defer></script>
</body>
</html>
