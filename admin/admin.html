<!DOCTYPE html>
<html lang="fr" translate="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="google" content="notranslate">
  <meta name="googlebot" content="notranslate">
  <meta http-equiv="Content-Language" content="fr">
  <title>Admin ‚Äì Clipsou Streaming</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" href="../images/favicon.webp" type="image/webp">
  <link rel="stylesheet" href="admin.css?v=20250910">
  <script src="../i18n.js"></script>
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>
    // Enforce apex domain online to share localStorage with the main site
    (function(){
      try {
        var h = location.hostname;
        var isLocal = location.protocol === 'file:' || h === 'localhost' || h === '127.0.0.1';
        if (isLocal) return;
        if (h === 'www.clipsoustreaming.com') {
          var target = 'https://clipsoustreaming.com' + location.pathname + location.search + location.hash;
          location.replace(target);
        }
      } catch {}
    })();
  </script>
</head>
<body class="notranslate">
  <main class="container" id="app" hidden>
    <h1>Clipsou Streaming ‚Äì Admin</h1>

    <section class="auth">
      <p class="muted">Acc√®s restreint. Votre session admin est active.</p>
      <div id="googleAuthContainer"></div>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <button id="logoutBtn" type="button" class="btn">Se d√©connecter</button>
        <a id="homeShortcut" href="../" class="btn secondary">Aller √† l'accueil</a>
        <button id="adminListBtn" type="button" class="btn admin-list-btn" title="G√©rer la liste des administrateurs">üë• Liste des admins</button>
      </div>
    </section>

    <!-- Onglets de navigation -->
    <nav class="admin-tabs">
      <button class="tab-button active" data-tab="requests">
        <span class="tab-emoji">üìù</span>
        <span class="tab-text">
          <span class="tab-short">Requ√™tes</span>
          <span class="tab-long"> d'ajout</span>
        </span>
      </button>
      <button class="tab-button" data-tab="user-requests">
        <span class="tab-emoji">üì¨</span>
        <span class="tab-text">
          <span class="tab-short">Demandes</span>
          <span class="tab-long"> utilisateurs</span>
        </span>
        <span id="userRequestsCountTab" class="badge notif-badge" hidden></span>
      </button>
      <button class="tab-button" data-tab="banned-users">
        <span class="tab-emoji">üö´</span>
        <span class="tab-text">
          <span class="tab-short">Bannis</span>
          <span class="tab-long"> utilisateurs</span>
        </span>
        <span id="bannedUsersCountTab" class="badge notif-badge" hidden></span>
      </button>
    </nav>

    <!-- Tab Content: Requ√™tes d'ajout -->
    <div class="tab-content active" id="tab-requests">

    <section class="form-section" id="cloudinary-section" hidden>
      <h2 style="display:flex; align-items:center; gap:8px;">
        Stockage images (Cloudinary)
        <button type="button" id="cldLockBtn" class="btn secondary lock-btn" title="Verrouiller/d√©verrouiller la configuration">üîí</button>
      </h2>
      <p class="muted small">Saisissez votre <strong>Cloud name</strong> et votre <strong>Upload preset</strong> (unsigned) pour activer l‚Äôupload en ligne. Ces r√©glages sont stock√©s dans votre navigateur.</p>
      <form id="cloudinaryForm">
        <div class="grid">
          <label>
            <span>Cloud name</span>
            <input type="text" id="cldCloudName" placeholder="ex: clipsoucloud" readonly>
          </label>
          <label>
            <span>Upload preset (unsigned)</span>
            <input type="text" id="cldUploadPreset" placeholder="ex: clipsou_unsigned" readonly>
          </label>
          <label>
            <span>Dossier (optionnel)</span>
            <input type="text" id="cldFolder" placeholder="ex: clipsou" readonly>
          </label>
        </div>
        <div class="actions" id="cldActionsRow">
          <button type="button" id="cldSaveBtn" class="btn" disabled>Enregistrer la configuration</button>
          <button type="button" id="cldClearBtn" class="btn secondary" disabled>R√©initialiser</button>
        </div>
        <p id="cldStatus" class="muted small"></p>
      </form>
    </section>

    <section class="form-section">
      <h2>Ajouter / Modifier un contenu</h2>
      <form id="contentForm">
        <input type="hidden" name="id" id="id">
        <input type="hidden" name="requestId" id="requestId">

        <div class="grid">
          <label>
            <span>Titre</span>
            <input type="text" id="title" required>
          </label>
          <label>
            <span>Type</span>
            <select id="type" required>
              <option value="film">Film</option>
              <option value="s√©rie">S√©rie</option>
              <option value="trailer">Trailer</option>
            </select>
          </label>
          <label>
            <span>Note (/5) - Lecture seule</span>
            <input type="number" id="rating" step="0.5" min="0" max="5" disabled readonly style="opacity: 0.6; cursor: not-allowed; background-color: rgba(255,255,255,0.05);">
          </label>
        </div>

        <div class="grid">
          <label>
            <span>Genre 1</span>
            <input type="text" id="genre1" list="genresDatalist" required>
          </label>
          <label>
            <span>Genre 2</span>
            <input type="text" id="genre2" list="genresDatalist" required>
          </label>
          <label>
            <span>Genre 3</span>
            <input type="text" id="genre3" list="genresDatalist" required>
          </label>
        </div>

        <label>
          <span>Description</span>
          <textarea id="description" rows="4" required></textarea>
        </label>

        <div class="grid">
          <label>
            <span>Affiche (format 9/12)</span>
            <input type="hidden" id="portraitImage">
            <div class="actions">
              <label class="btn file-label">
                Importer image
                <input type="file" id="portraitFileInput" accept="image/*" hidden>
              </label>
              <button type="button" id="portraitClearBtn" class="btn secondary">Effacer</button>
            </div>
            <img id="portraitPreview" class="img-preview" alt="Aper√ßu portrait" hidden>
          </label>
          <label>
            <span>Image fiche (paysage 16/9)</span>
            <input type="hidden" id="landscapeImage">
            <div class="actions">
              <label class="btn file-label">
                Importer image
                <input type="file" id="landscapeFileInput" accept="image/*" hidden>
              </label>
              <button type="button" id="landscapeClearBtn" class="btn secondary">Effacer</button>
            </div>
            <img id="landscapePreview" class="img-preview" alt="Aper√ßu paysage" hidden>
          </label>
          <label>
            <span>√âtiquette studio (image)</span>
            <input type="hidden" id="studioBadge">
            <div class="actions">
              <label class="btn file-label">
                Importer image
                <input type="file" id="studioBadgeFileInput" accept="image/*" hidden>
              </label>
              <button type="button" id="studioBadgeClearBtn" class="btn secondary">Effacer</button>
            </div>
            <img id="studioBadgePreview" class="img-preview" alt="Aper√ßu √©tiquette studio" hidden>
          </label>
        </div>

        <fieldset>
          <legend>Acteurs & Doubleurs</legend>
          <div id="actorsList" class="actors-list"></div>
          <div class="actor-row">
            <input type="text" id="actorName" placeholder="Nom" list="actorNamesDatalist">
            <input type="text" id="actorRole" placeholder="R√¥le">
            <label class="btn file-label" title="Photo de profil (optionnel)">
              Photo
              <input type="file" id="actorPhotoFile" accept="image/*" hidden>
            </label>
            <img id="actorPhotoPreview" class="img-preview small" alt="Aper√ßu acteur" hidden>
            <button type="button" id="addActorBtn" class="btn secondary">Ajouter</button>
          </div>
        </fieldset>

        <fieldset id="watchUrlFieldset">
          <legend>Lien de visionnage</legend>
          <label>
            <span>Lien YouTube</span>
            <input type="url" id="watchUrl" placeholder="https://www.youtube.com/...">
          </label>
        </fieldset>

        <fieldset id="episodesFieldset" style="display:none;">
          <legend>√âpisodes</legend>
          <div id="episodesList" class="actors-list"></div>
          <div class="actor-row">
            <input type="text" id="episodeTitle" placeholder="Titre de l'√©pisode" style="flex:2;">
            <input type="url" id="episodeUrl" placeholder="Lien YouTube de l'√©pisode" style="flex:2;">
            <button type="button" id="addEpisodeBtn" class="btn secondary">Ajouter</button>
          </div>
        </fieldset>

        <div class="actions">
          <button type="submit" class="btn">Enregistrer la requ√™te</button>
          <button type="button" id="resetBtn" class="btn secondary">Nouveau</button>
        </div>
      </form>
      <datalist id="genresDatalist"></datalist>
      <datalist id="actorNamesDatalist"></datalist>
    </section>

    <section class="requests trash-section">
      <h2>üóëÔ∏è Corbeille</h2>
      <p class="muted">Films supprim√©s ‚Äì Vous pouvez les restaurer ou les supprimer d√©finitivement.</p>
      <div id="trashSection" style="margin-bottom:24px;">
        <div class="actions" style="margin:12px 0;">
          <button type="button" id="emptyTrashBtn" class="btn secondary">Vider la corbeille</button>
        </div>
        <table class="table" id="trashTable" aria-describedby="trashHelp">
          <thead>
            <tr>
              <th>Titre</th>
              <th>Type</th>
              <th>Genres</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <p id="trashHelp" class="muted small" style="margin-top:8px;">La corbeille contient les films supprim√©s. Vous pouvez les restaurer ou les supprimer d√©finitivement.</p>
      </div>
    </section>

    <section class="requests main-requests-section">
      <h2>üìù Requ√™tes d'ajout</h2>
      <form class="search-row" autocomplete="off" onsubmit="return false" role="search" style="display:flex;gap:10px;align-items:center;margin:8px 0 12px 0;flex-wrap:wrap">
        <label for="requestsSearch" class="muted" style="min-width:120px">Recherche</label>
        <input id="requestsSearch" name="admin_requests_search" type="search" placeholder="Rechercher par titre, type, genre, id, acteur‚Ä¶" style="flex:1;min-width:240px;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.15);background:#0f1720;color:#fff;outline:none" autocomplete="off" autocapitalize="none" autocorrect="off" spellcheck="false" enterkeyhint="search" inputmode="search" data-1p-ignore="true" data-lpignore="true" data-bwignore="true">
        <label for="requestsSort" class="muted" style="min-width:60px">Trier par</label>
        <select id="requestsSort" style="padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.15);background:#0f1720;color:#fff;outline:none;min-width:180px">
          <option value="recent">Modifications r√©centes</option>
          <option value="alpha">Ordre alphab√©tique</option>
          <option value="type">Type</option>
        </select>
        <!-- decoy password field to attract Chrome/PM autofill away from the search input -->
        <input type="password" name="password" autocomplete="new-password" tabindex="-1" aria-hidden="true" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;pointer-events:none">
      </form>
      <table class="table" id="requestsTable" aria-describedby="requestsHelp">
        <thead>
          <tr>
            <th>Titre</th>
            <th>Type</th>
            <th>Genres</th>
            <th>Note</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p id="requestsHelp" class="muted">Approuvez une requ√™te pour la publier. Vous pouvez modifier ou supprimer √† tout moment.</p>
    </section>

    </div>
    <!-- End Tab Content: Requ√™tes d'ajout -->

    <!-- Tab Content: Demandes utilisateurs -->
    <div class="tab-content" id="tab-user-requests">

    <section class="user-requests">
      <h2>üì¨ Demandes utilisateurs <span id="userRequestsCount" class="badge notif-badge" hidden></span></h2>
      <p class="muted">Les utilisateurs peuvent soumettre leurs films via la page publique. Validez les demandes pour les transf√©rer dans "Requ√™tes d'ajout" o√π vous pourrez les approuver.</p>
      <p class="muted small" id="localModeNotice" style="display:none; color: #fbbf24;">üöß <strong>Mode local</strong> : Les demandes sont lues depuis localStorage. Rafra√Æchissement automatique toutes les 5 secondes.</p>
      <div class="actions">
        <button type="button" id="syncUserRequestsBtn" class="btn secondary">üîÑ Synchroniser</button>
      </div>
      <table class="table" id="userRequestsTable">
        <thead>
          <tr>
            <th>Titre</th>
            <th>Type</th>
            <th>Soumis le</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p class="muted small">Note : Les demandes valid√©es sont transf√©r√©es dans "Requ√™tes d'ajout" o√π vous pouvez les modifier avant publication.</p>
    </section>

    </div>
    <!-- End Tab Content: Demandes utilisateurs -->

    <!-- Tab Content: Utilisateurs bannis -->
    <div class="tab-content" id="tab-banned-users">

    <section class="form-section banned-users-section">
      <h2>üö´ Utilisateurs bannis <span id="bannedUsersCount" class="badge notif-badge" hidden></span></h2>
      <p class="muted">G√©rez les utilisateurs bannis qui ne peuvent plus soumettre de demandes. Vous pouvez les bannir depuis les demandes utilisateurs ou manuellement.</p>
      
      <div class="ban-user-manual">
        <h3>Bannir un utilisateur manuellement</h3>
        <div class="grid" style="grid-template-columns: 1fr 1fr 1fr auto;">
          <label>
            <span>Email Google</span>
            <input type="email" id="banUserEmail" placeholder="email@gmail.com">
          </label>
          <label>
            <span>Nom d'utilisateur (optionnel)</span>
            <input type="text" id="banUserName" placeholder="Nom">
          </label>
          <label>
            <span>ID Cha√Æne YouTube (optionnel)</span>
            <input type="text" id="banUserChannelId" placeholder="UCxxxxxxxxx">
          </label>
          <div style="display:flex; align-items:flex-end;">
            <button type="button" id="addBanBtn" class="btn danger">üö´ Bannir</button>
          </div>
        </div>
      </div>

      <table class="table" id="bannedUsersTable">
        <thead>
          <tr>
            <th>Email</th>
            <th>Nom</th>
            <th>Cha√Æne YouTube</th>
            <th>Banni le</th>
            <th>Raison</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p class="muted small" id="bannedUsersEmpty">Aucun utilisateur banni.</p>
    </section>

    </div>
    <!-- End Tab Content: Utilisateurs bannis -->

  </main>

  <div id="login" class="login">
    <h1>Admin ‚Äì Connexion</h1>
    <p class="muted">‚ö†Ô∏è <strong>√âtape 1/2 :</strong> Connectez-vous d'abord avec votre compte Google admin.</p>
    
    <!-- Google Sign-In Button -->
    <div id="googleSignInButton" style="display:flex; justify-content:center; margin:16px 0;"></div>
    <div id="googleAuthStatus" style="display:none; text-align:center; margin:12px 0; padding:12px; background:rgba(34,197,94,0.1); border:1px solid rgba(34,197,94,0.3); border-radius:8px;">
      <p style="color:#22c55e; font-weight:600; margin:0;">‚úÖ Connect√© avec Google</p>
      <p class="muted small" style="margin:4px 0 0 0;" id="googleAuthEmail"></p>
    </div>
    <p class="muted small" style="text-align:center; margin:8px 0;">Connexion Google requise (email autoris√© uniquement)</p>
    <p class="muted small" style="text-align:center; margin:8px 0;">
      <a href="../privacy.html" target="_blank" rel="noopener noreferrer" style="color: #3b82f6; text-decoration: none;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
        </svg>
        Politique de confidentialit√©
      </a>
    </p>
    
    <hr style="border:none; border-top:1px solid #334155; margin:24px 0;">
    
    <div id="passwordSection" style="opacity:0.5; pointer-events:none;">
      <p class="muted" style="text-align:center; margin-bottom:16px;"><strong>√âtape 2/2 :</strong> Entrez le mot de passe admin</p>
      <!-- Provide a dedicated username field so Chrome pairs credentials here instead of targeting unrelated inputs -->
      <input id="usernameInput" name="username" type="text" autocomplete="username" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;pointer-events:none" tabindex="-1" aria-hidden="true">
      <!-- Hidden current-password decoy to further attract autofill away from the search field -->
      <input type="password" name="password" autocomplete="current-password" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;pointer-events:none" tabindex="-1" aria-hidden="true">
      <input id="passwordInput" name="admin_password" type="password" placeholder="Mot de passe admin" autocomplete="current-password" autocapitalize="none" autocorrect="off" spellcheck="false" disabled>
      <div style="display:flex; gap:12px; justify-content:center; align-items:center; margin:8px 0;">
        <label style="display:flex; gap:6px; align-items:center;">
          <input id="showPwd" type="checkbox" disabled>
          <span>Afficher le mot de passe</span>
        </label>
      </div>
      <button id="loginBtn" class="btn" disabled>Se connecter</button>
      <p class="muted small" style="text-align:center; margin-top:8px;">üîí Veuillez d'abord vous connecter avec Google</p>
    </div>
    <div style="margin-top:8px;">
      <a id="homeShortcutLogin" href="../" class="btn secondary">Retour √† l'accueil</a>
    </div>
  </div>

  <script src="../config.js"></script>
  <script src="../google-auth.js?v=20251031-buttonalign"></script>
  <script src="admin-auth.js?v=20251031-superadmin"></script>
  <script src="admin.js?v=20251031-profilefix" defer></script>
  <script>
    // Initialize Google Auth in Admin Mode (no YouTube channel required)
    (function() {
      console.log('[Admin] Preparing admin authentication system...');
      
      // Wait for GoogleAuth to be available
      const initAdminGoogleAuth = setInterval(() => {
        if (window.GoogleAuth && typeof window.GoogleAuth.setAdminMode === 'function') {
          clearInterval(initAdminGoogleAuth);
          
          // Enable admin mode
          window.GoogleAuth.setAdminMode(true);
          console.log('[Admin] ‚úÖ Admin mode enabled for Google Authentication');
          
          // Initialize Google Auth
          if (typeof window.GoogleAuth.initGoogleAuth === 'function') {
            window.GoogleAuth.initGoogleAuth().then(() => {
              console.log('[Admin] ‚úÖ Google Auth initialized');
              
              // Check if user is already authenticated
              checkGoogleAuthAndEnablePassword();
            }).catch(err => {
              console.error('[Admin] ‚ùå Failed to initialize Google Auth:', err);
            });
          }
        }
      }, 100);
      
      // Timeout after 10 seconds
      setTimeout(() => {
        clearInterval(initAdminGoogleAuth);
      }, 10000);
      
      // Function to check Google Auth and enable password form
      function checkGoogleAuthAndEnablePassword() {
        console.log('[Admin] checkGoogleAuthAndEnablePassword called');
        console.log('[Admin] GoogleAuth exists:', !!window.GoogleAuth);
        console.log('[Admin] isAuthenticated exists:', !!(window.GoogleAuth && window.GoogleAuth.isAuthenticated));
        
        // Check if already authenticated
        if (window.GoogleAuth && window.GoogleAuth.isAuthenticated && window.GoogleAuth.isAuthenticated()) {
          console.log('[Admin] GoogleAuth.isAuthenticated() = true');
          const user = window.GoogleAuth.getCurrentUser();
          console.log('[Admin] getCurrentUser() result:', user);
          if (user && user.user) {
            console.log('[Admin] üîê Google already authenticated, enabling password form');
            console.log('[Admin] User email:', user.user.email);
            enablePasswordForm(user.user.email);
            return;
          } else {
            console.warn('[Admin] isAuthenticated=true but no user data!');
          }
        } else {
          console.log('[Admin] GoogleAuth.isAuthenticated() = false or not available');
        }
        
        // Listen for Google Auth success event
        console.log('[Admin] Listening for googleAuthSuccess event...');
        window.addEventListener('googleAuthSuccess', function(event) {
          console.log('[Admin] üîê Google Auth event received!', event.detail);
          if (event.detail && event.detail.email) {
            enablePasswordForm(event.detail.email);
          }
        }, { once: true });
        
        // Also check again after a short delay in case of timing issues
        setTimeout(() => {
          console.log('[Admin] Delayed check for Google Auth...');
          if (window.GoogleAuth && window.GoogleAuth.isAuthenticated && window.GoogleAuth.isAuthenticated()) {
            const user = window.GoogleAuth.getCurrentUser();
            console.log('[Admin] Delayed check - user:', user);
            if (user && user.user && user.user.email) {
              console.log('[Admin] üîê Delayed check found auth, enabling password form');
              enablePasswordForm(user.user.email);
            }
          }
        }, 500);
      }
      
      // Function to enable password form after Google authentication
      function enablePasswordForm(email) {
        console.log('[Admin] enablePasswordForm called with email:', email);
        const passwordSection = document.getElementById('passwordSection');
        const passwordInput = document.getElementById('passwordInput');
        const loginBtn = document.getElementById('loginBtn');
        const showPwd = document.getElementById('showPwd');
        const googleAuthStatus = document.getElementById('googleAuthStatus');
        const googleAuthEmail = document.getElementById('googleAuthEmail');
        const googleSignInButton = document.getElementById('googleSignInButton');
        
        if (passwordSection) {
          passwordSection.style.opacity = '1';
          passwordSection.style.pointerEvents = 'auto';
        }
        
        if (passwordInput) {
          passwordInput.disabled = false;
          // Don't auto-focus if user is already typing
          if (document.activeElement !== passwordInput) {
            passwordInput.focus();
          }
        }
        
        if (loginBtn) {
          loginBtn.disabled = false;
        }
        
        if (showPwd) {
          showPwd.disabled = false;
        }
        
        // Show Google auth status
        if (googleAuthStatus) {
          googleAuthStatus.style.display = 'block';
        }
        
        if (googleAuthEmail) {
          googleAuthEmail.textContent = email;
        }
        
        // Hide Google Sign-In button
        if (googleSignInButton) {
          googleSignInButton.style.display = 'none';
        }
        
        console.log('[Admin] ‚úÖ Password form enabled');
      }
      
      // Function to disable password form after Google logout
      function disablePasswordForm() {
        console.log('[Admin] disablePasswordForm called');
        const passwordSection = document.getElementById('passwordSection');
        const passwordInput = document.getElementById('passwordInput');
        const loginBtn = document.getElementById('loginBtn');
        const showPwd = document.getElementById('showPwd');
        const googleAuthStatus = document.getElementById('googleAuthStatus');
        const googleSignInButton = document.getElementById('googleSignInButton');
        
        if (passwordSection) {
          passwordSection.style.opacity = '0.5';
          passwordSection.style.pointerEvents = 'none';
        }
        
        if (passwordInput) {
          passwordInput.disabled = true;
          passwordInput.value = ''; // Clear password field
        }
        
        if (loginBtn) {
          loginBtn.disabled = true;
        }
        
        if (showPwd) {
          showPwd.disabled = true;
          showPwd.checked = false; // Reset checkbox
        }
        
        // Hide Google auth status
        if (googleAuthStatus) {
          googleAuthStatus.style.display = 'none';
        }
        
        // Show Google Sign-In button again
        if (googleSignInButton) {
          googleSignInButton.style.display = '';
        }
        
        console.log('[Admin] ‚úÖ Password form disabled');
      }
      
      // Listen for Google logout event
      window.addEventListener('googleAuthLogout', function() {
        console.log('[Admin] üîì Google logout event received');
        disablePasswordForm();
        
        // Also check if we need to reload the page or just reset the form
        // In admin context, we should stay on the login screen
      });
      
      // Expose functions globally for admin.js to use
      window.enablePasswordForm = enablePasswordForm;
      window.disablePasswordForm = disablePasswordForm;
      window.checkGoogleAuthAndEnablePassword = checkGoogleAuthAndEnablePassword;
    })();
  </script>
  <script>
    // Setup admin buttons
    document.addEventListener('DOMContentLoaded', function() {
      // Admin list button
      const adminListBtn = document.getElementById('adminListBtn');
      if (adminListBtn && window.AdminAuth) {
        adminListBtn.addEventListener('click', function() {
          window.AdminAuth.showAdminListPopup();
        });
      }
      
      // Logout button - handle both Google logout and admin session
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
          console.log('[Admin] Logout button clicked');
          
          // First logout from Google
          if (window.GoogleAuth && typeof window.GoogleAuth.logout === 'function') {
            console.log('[Admin] Calling GoogleAuth.logout()');
            window.GoogleAuth.logout();
          }
          
          // Then clear admin session
          try {
            localStorage.removeItem('clipsou_admin_logged_in_v1');
            sessionStorage.removeItem('clipsou_admin_session_v1');
            console.log('[Admin] Admin session cleared');
          } catch (e) {
            console.error('[Admin] Error clearing admin session:', e);
          }
          
          // Reload page to show login screen
          setTimeout(() => {
            window.location.reload();
          }, 100);
        });
      }
    });
  </script>
  <script>
    // Extra guard: delay enabling typing in the search box until real user interaction
    (function(){
      try {
        var el = document.getElementById('requestsSearch');
        if (!el) return;
        // Mark readonly to dissuade password managers; remove on first interaction
        el.setAttribute('readonly','readonly');
        var enable = function(){ try { el.removeAttribute('readonly'); } catch{} };
        el.addEventListener('pointerdown', enable, { once: true });
        el.addEventListener('focus', enable, { once: true });
        el.addEventListener('keydown', enable, { once: true });
        // Randomize name and force autocomplete to new-password to avoid PM heuristics
        try { el.setAttribute('name', 'admin_requests_search_' + Date.now()); } catch{}
        try { el.setAttribute('autocomplete', 'new-password'); } catch{}
        // Also re-randomize name on focus and on user typing, to defeat persistent mappings
        var rerand = function(){ try { el.setAttribute('name', 'admin_requests_search_' + Date.now() + '_' + Math.floor(Math.random()*1e6)); } catch{} };
        el.addEventListener('focus', rerand);
        // Remove automatic rerand on input to prevent unwanted filtering
        // el.addEventListener('input', rerand);
      } catch {}
    })();
  </script>
  <script>
    // Tabs switching system
    (function() {
      document.addEventListener('DOMContentLoaded', function() {
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        
        function switchTab(tabName) {
          // Remove active class from all buttons and contents
          tabButtons.forEach(btn => btn.classList.remove('active'));
          tabContents.forEach(content => content.classList.remove('active'));
          
          // Add active class to selected button and content
          const selectedButton = document.querySelector(`.tab-button[data-tab="${tabName}"]`);
          const selectedContent = document.getElementById(`tab-${tabName}`);
          
          if (selectedButton) selectedButton.classList.add('active');
          if (selectedContent) selectedContent.classList.add('active');
          
          // Save selected tab in sessionStorage
          try {
            sessionStorage.setItem('clipsou_admin_active_tab', tabName);
          } catch(e) {}
        }
        
        // Add click listeners to all tab buttons
        tabButtons.forEach(button => {
          button.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');
            switchTab(tabName);
          });
        });
        
        // Restore last active tab from sessionStorage
        try {
          const savedTab = sessionStorage.getItem('clipsou_admin_active_tab');
          if (savedTab) {
            switchTab(savedTab);
          }
        } catch(e) {}
        
        // Sync badge counts between tab buttons and section headers
        function syncBadgeCounts() {
          // User requests count
          const userReqCount = document.getElementById('userRequestsCount');
          const userReqCountTab = document.getElementById('userRequestsCountTab');
          if (userReqCount && userReqCountTab) {
            if (userReqCount.hidden) {
              userReqCountTab.hidden = true;
            } else {
              userReqCountTab.hidden = false;
              userReqCountTab.textContent = userReqCount.textContent;
              userReqCountTab.className = userReqCount.className;
            }
          }
          
          // Banned users count
          const bannedCount = document.getElementById('bannedUsersCount');
          const bannedCountTab = document.getElementById('bannedUsersCountTab');
          if (bannedCount && bannedCountTab) {
            if (bannedCount.hidden) {
              bannedCountTab.hidden = true;
            } else {
              bannedCountTab.hidden = false;
              bannedCountTab.textContent = bannedCount.textContent;
              bannedCountTab.className = bannedCount.className;
            }
          }
        }
        
        // Sync badge counts on load and periodically
        syncBadgeCounts();
        setInterval(syncBadgeCounts, 1000);
        
        // Observe changes to badge elements
        const observer = new MutationObserver(syncBadgeCounts);
        const userReqCount = document.getElementById('userRequestsCount');
        const bannedCount = document.getElementById('bannedUsersCount');
        if (userReqCount) observer.observe(userReqCount, { attributes: true, childList: true, characterData: true, subtree: true });
        if (bannedCount) observer.observe(bannedCount, { attributes: true, childList: true, characterData: true, subtree: true });
      });
    })();
  </script>
</body>
</html>
