<!DOCTYPE html>
<html lang="fr" translate="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="google" content="notranslate">
  <meta name="googlebot" content="notranslate">
  <meta http-equiv="Content-Language" content="fr">
  <title>Admin â€“ Clipsou Streaming</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" href="../images/favicon.webp" type="image/webp">
  <link rel="stylesheet" href="admin.css?v=20250910">
  <script src="../i18n.js"></script>
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>
    // Enforce apex domain online to share localStorage with the main site
    (function(){
      try {
        var h = location.hostname;
        var isLocal = location.protocol === 'file:' || h === 'localhost' || h === '127.0.0.1';
        if (isLocal) return;
        if (h === 'www.clipsoustreaming.com') {
          var target = 'https://clipsoustreaming.com' + location.pathname + location.search + location.hash;
          location.replace(target);
        }
      } catch {}
    })();
  </script>
</head>
<body class="notranslate">
  <main class="container" id="app" hidden>
    <h1>Clipsou Streaming â€“ Admin</h1>

    <section class="auth">
      <p class="muted">AccÃ¨s restreint. Votre session admin est active.</p>
      <div id="googleAuthContainer"></div>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <button id="logoutBtn" type="button" class="btn">Se dÃ©connecter</button>
        <a id="homeShortcut" href="../" class="btn secondary">Aller Ã  l'accueil</a>
        <button id="adminListBtn" type="button" class="btn admin-list-btn" title="GÃ©rer la liste des administrateurs">ðŸ‘¥ Liste des admins</button>
      </div>
    </section>

    <section class="form-section" id="cloudinary-section" hidden>
      <h2 style="display:flex; align-items:center; gap:8px;">
        Stockage images (Cloudinary)
        <button type="button" id="cldLockBtn" class="btn secondary lock-btn" title="Verrouiller/dÃ©verrouiller la configuration">ðŸ”’</button>
      </h2>
      <p class="muted small">Saisissez votre <strong>Cloud name</strong> et votre <strong>Upload preset</strong> (unsigned) pour activer lâ€™upload en ligne. Ces rÃ©glages sont stockÃ©s dans votre navigateur.</p>
      <form id="cloudinaryForm">
        <div class="grid">
          <label>
            <span>Cloud name</span>
            <input type="text" id="cldCloudName" placeholder="ex: clipsoucloud" readonly>
          </label>
          <label>
            <span>Upload preset (unsigned)</span>
            <input type="text" id="cldUploadPreset" placeholder="ex: clipsou_unsigned" readonly>
          </label>
          <label>
            <span>Dossier (optionnel)</span>
            <input type="text" id="cldFolder" placeholder="ex: clipsou" readonly>
          </label>
        </div>
        <div class="actions" id="cldActionsRow">
          <button type="button" id="cldSaveBtn" class="btn" disabled>Enregistrer la configuration</button>
          <button type="button" id="cldClearBtn" class="btn secondary" disabled>RÃ©initialiser</button>
        </div>
        <p id="cldStatus" class="muted small"></p>
      </form>
    </section>

    <section class="form-section">
      <h2>Ajouter / Modifier un contenu</h2>
      <form id="contentForm">
        <input type="hidden" name="id" id="id">
        <input type="hidden" name="requestId" id="requestId">

        <div class="grid">
          <label>
            <span>Titre</span>
            <input type="text" id="title" required>
          </label>
          <label>
            <span>Type</span>
            <select id="type" required>
              <option value="film">Film</option>
              <option value="sÃ©rie">SÃ©rie</option>
              <option value="trailer">Trailer</option>
            </select>
          </label>
          <label>
            <span>Note (/5) - Lecture seule</span>
            <input type="number" id="rating" step="0.5" min="0" max="5" disabled readonly style="opacity: 0.6; cursor: not-allowed; background-color: rgba(255,255,255,0.05);">
          </label>
        </div>

        <div class="grid">
          <label>
            <span>Genre 1</span>
            <input type="text" id="genre1" list="genresDatalist" required>
          </label>
          <label>
            <span>Genre 2</span>
            <input type="text" id="genre2" list="genresDatalist" required>
          </label>
          <label>
            <span>Genre 3</span>
            <input type="text" id="genre3" list="genresDatalist" required>
          </label>
        </div>

        <label>
          <span>Description</span>
          <textarea id="description" rows="4" required></textarea>
        </label>

        <div class="grid">
          <label>
            <span>Affiche (format 9/12)</span>
            <input type="hidden" id="portraitImage">
            <div class="actions">
              <label class="btn file-label">
                Importer image
                <input type="file" id="portraitFileInput" accept="image/*" hidden>
              </label>
              <button type="button" id="portraitClearBtn" class="btn secondary">Effacer</button>
            </div>
            <img id="portraitPreview" class="img-preview" alt="AperÃ§u portrait" hidden>
          </label>
          <label>
            <span>Image fiche (paysage 16/9)</span>
            <input type="hidden" id="landscapeImage">
            <div class="actions">
              <label class="btn file-label">
                Importer image
                <input type="file" id="landscapeFileInput" accept="image/*" hidden>
              </label>
              <button type="button" id="landscapeClearBtn" class="btn secondary">Effacer</button>
            </div>
            <img id="landscapePreview" class="img-preview" alt="AperÃ§u paysage" hidden>
          </label>
          <label>
            <span>Ã‰tiquette studio (image)</span>
            <input type="hidden" id="studioBadge">
            <div class="actions">
              <label class="btn file-label">
                Importer image
                <input type="file" id="studioBadgeFileInput" accept="image/*" hidden>
              </label>
              <button type="button" id="studioBadgeClearBtn" class="btn secondary">Effacer</button>
            </div>
            <img id="studioBadgePreview" class="img-preview" alt="AperÃ§u Ã©tiquette studio" hidden>
          </label>
        </div>

        <fieldset>
          <legend>Acteurs & Doubleurs</legend>
          <div id="actorsList" class="actors-list"></div>
          <div class="actor-row">
            <input type="text" id="actorName" placeholder="Nom" list="actorNamesDatalist">
            <input type="text" id="actorRole" placeholder="RÃ´le">
            <label class="btn file-label" title="Photo de profil (optionnel)">
              Photo
              <input type="file" id="actorPhotoFile" accept="image/*" hidden>
            </label>
            <img id="actorPhotoPreview" class="img-preview small" alt="AperÃ§u acteur" hidden>
            <button type="button" id="addActorBtn" class="btn secondary">Ajouter</button>
          </div>
        </fieldset>

        <fieldset id="watchUrlFieldset">
          <legend>Lien de visionnage</legend>
          <label>
            <span>Lien YouTube</span>
            <input type="url" id="watchUrl" placeholder="https://www.youtube.com/...">
          </label>
        </fieldset>

        <fieldset id="episodesFieldset" style="display:none;">
          <legend>Ã‰pisodes</legend>
          <div id="episodesList" class="actors-list"></div>
          <div class="actor-row">
            <input type="text" id="episodeTitle" placeholder="Titre de l'Ã©pisode" style="flex:2;">
            <input type="url" id="episodeUrl" placeholder="Lien YouTube de l'Ã©pisode" style="flex:2;">
            <button type="button" id="addEpisodeBtn" class="btn secondary">Ajouter</button>
          </div>
        </fieldset>

        <div class="actions">
          <button type="submit" class="btn">Enregistrer la requÃªte</button>
          <button type="button" id="resetBtn" class="btn secondary">Nouveau</button>
        </div>
      </form>
      <datalist id="genresDatalist"></datalist>
      <datalist id="actorNamesDatalist"></datalist>
    </section>

    <section class="requests">
      <h2>Corbeille</h2>
      <p class="muted">Films supprimÃ©s â€“ Vous pouvez les restaurer ou les supprimer dÃ©finitivement.</p>
      <div id="trashSection" style="margin-bottom:24px;">
        <div class="actions" style="margin:12px 0;">
          <button type="button" id="emptyTrashBtn" class="btn secondary">Vider la corbeille</button>
        </div>
        <table class="table" id="trashTable" aria-describedby="trashHelp">
          <thead>
            <tr>
              <th>Titre</th>
              <th>Type</th>
              <th>Genres</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <p id="trashHelp" class="muted small" style="margin-top:8px;">La corbeille contient les films supprimÃ©s. Vous pouvez les restaurer ou les supprimer dÃ©finitivement.</p>
      </div>
    </section>

    <section class="requests">
      <h2>RequÃªtes d'ajout</h2>
      <form class="search-row" autocomplete="off" onsubmit="return false" role="search" style="display:flex;gap:10px;align-items:center;margin:8px 0 12px 0;flex-wrap:wrap">
        <label for="requestsSearch" class="muted" style="min-width:120px">Recherche</label>
        <input id="requestsSearch" name="admin_requests_search" type="search" placeholder="Rechercher par titre, type, genre, id, acteurâ€¦" style="flex:1;min-width:240px;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.15);background:#0f1720;color:#fff;outline:none" autocomplete="off" autocapitalize="none" autocorrect="off" spellcheck="false" enterkeyhint="search" inputmode="search" data-1p-ignore="true" data-lpignore="true" data-bwignore="true">
        <label for="requestsSort" class="muted" style="min-width:60px">Trier par</label>
        <select id="requestsSort" style="padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.15);background:#0f1720;color:#fff;outline:none;min-width:180px">
          <option value="recent">Modifications rÃ©centes</option>
          <option value="alpha">Ordre alphabÃ©tique</option>
          <option value="type">Type</option>
        </select>
        <!-- decoy password field to attract Chrome/PM autofill away from the search input -->
        <input type="password" name="password" autocomplete="new-password" tabindex="-1" aria-hidden="true" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;pointer-events:none">
      </form>
      <table class="table" id="requestsTable" aria-describedby="requestsHelp">
        <thead>
          <tr>
            <th>Titre</th>
            <th>Type</th>
            <th>Genres</th>
            <th>Note</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p id="requestsHelp" class="muted">Approuvez une requÃªte pour la publier. Vous pouvez modifier ou supprimer Ã  tout moment.</p>
    </section>

    <section class="user-requests">
      <h2>ðŸ“¬ Demandes utilisateurs <span id="userRequestsCount" class="badge notif-badge" hidden></span></h2>
      <p class="muted">Les utilisateurs peuvent soumettre leurs films via la page publique. Validez les demandes pour les transfÃ©rer dans "RequÃªtes d'ajout" oÃ¹ vous pourrez les approuver.</p>
      <p class="muted small" id="localModeNotice" style="display:none; color: #fbbf24;">ðŸš§ <strong>Mode local</strong> : Les demandes sont lues depuis localStorage. RafraÃ®chissement automatique toutes les 5 secondes.</p>
      <div class="actions">
        <button type="button" id="syncUserRequestsBtn" class="btn secondary">ðŸ”„ Synchroniser</button>
      </div>
      <table class="table" id="userRequestsTable">
        <thead>
          <tr>
            <th>Titre</th>
            <th>Type</th>
            <th>Soumis le</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p class="muted small">Note : Les demandes validÃ©es sont transfÃ©rÃ©es dans "RequÃªtes d'ajout" ci-dessus oÃ¹ vous pouvez les modifier avant publication.</p>
    </section>

    <section class="form-section banned-users-section">
      <h2>ðŸš« Utilisateurs bannis <span id="bannedUsersCount" class="badge notif-badge" hidden></span></h2>
      <p class="muted">GÃ©rez les utilisateurs bannis qui ne peuvent plus soumettre de demandes. Vous pouvez les bannir depuis les demandes utilisateurs ou manuellement.</p>
      
      <div class="ban-user-manual">
        <h3>Bannir un utilisateur manuellement</h3>
        <div class="grid" style="grid-template-columns: 1fr 1fr 1fr auto;">
          <label>
            <span>Email Google</span>
            <input type="email" id="banUserEmail" placeholder="email@gmail.com">
          </label>
          <label>
            <span>Nom d'utilisateur (optionnel)</span>
            <input type="text" id="banUserName" placeholder="Nom">
          </label>
          <label>
            <span>ID ChaÃ®ne YouTube (optionnel)</span>
            <input type="text" id="banUserChannelId" placeholder="UCxxxxxxxxx">
          </label>
          <div style="display:flex; align-items:flex-end;">
            <button type="button" id="addBanBtn" class="btn danger">ðŸš« Bannir</button>
          </div>
        </div>
      </div>

      <table class="table" id="bannedUsersTable">
        <thead>
          <tr>
            <th>Email</th>
            <th>Nom</th>
            <th>ChaÃ®ne YouTube</th>
            <th>Banni le</th>
            <th>Raison</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p class="muted small" id="bannedUsersEmpty">Aucun utilisateur banni.</p>
    </section>
  </main>

  <div id="login" class="login">
    <h1>Admin â€“ Connexion</h1>
    <p class="muted">Entrez le mot de passe admin et connectez-vous avec Google pour accÃ©der Ã  l'interface.</p>
    
    <!-- Google Sign-In Button -->
    <div id="googleSignInButton" style="display:flex; justify-content:center; margin:16px 0;"></div>
    <p class="muted small" style="text-align:center; margin:8px 0;">Connexion Google requise (email autorisÃ© uniquement)</p>
    <p class="muted small" style="text-align:center; margin:8px 0;">
      <a href="../privacy.html" target="_blank" rel="noopener noreferrer" style="color: #3b82f6; text-decoration: none;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
        </svg>
        Politique de confidentialitÃ©
      </a>
    </p>
    
    <hr style="border:none; border-top:1px solid #334155; margin:24px 0;">
    
    <!-- Provide a dedicated username field so Chrome pairs credentials here instead of targeting unrelated inputs -->
    <input id="usernameInput" name="username" type="text" autocomplete="username" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;pointer-events:none" tabindex="-1" aria-hidden="true">
    <!-- Hidden current-password decoy to further attract autofill away from the search field -->
    <input type="password" name="password" autocomplete="current-password" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;pointer-events:none" tabindex="-1" aria-hidden="true">
    <input id="passwordInput" name="admin_password" type="password" placeholder="Mot de passe" autocomplete="current-password" autocapitalize="none" autocorrect="off" spellcheck="false">
    <div style="display:flex; gap:12px; justify-content:center; align-items:center; margin:8px 0;">
      <label style="display:flex; gap:6px; align-items:center;">
        <input id="showPwd" type="checkbox">
        <span>Afficher le mot de passe</span>
      </label>
    </div>
    <button id="loginBtn" class="btn">Se connecter</button>
    <div style="margin-top:8px;">
      <a id="homeShortcutLogin" href="../" class="btn secondary">Retour Ã  l'accueil</a>
    </div>
  </div>

  <script src="../config.js"></script>
  <script src="../google-auth.js?v=20251031-buttonalign"></script>
  <script src="admin-auth.js?v=20251031-superadmin"></script>
  <script src="admin.js?v=20251031-profilefix" defer></script>
  <script>
    // Setup admin list button
    document.addEventListener('DOMContentLoaded', function() {
      const adminListBtn = document.getElementById('adminListBtn');
      if (adminListBtn && window.AdminAuth) {
        adminListBtn.addEventListener('click', function() {
          window.AdminAuth.showAdminListPopup();
        });
      }
    });
  </script>
  <script>
    // Extra guard: delay enabling typing in the search box until real user interaction
    (function(){
      try {
        var el = document.getElementById('requestsSearch');
        if (!el) return;
        // Mark readonly to dissuade password managers; remove on first interaction
        el.setAttribute('readonly','readonly');
        var enable = function(){ try { el.removeAttribute('readonly'); } catch{} };
        el.addEventListener('pointerdown', enable, { once: true });
        el.addEventListener('focus', enable, { once: true });
        el.addEventListener('keydown', enable, { once: true });
        // Randomize name and force autocomplete to new-password to avoid PM heuristics
        try { el.setAttribute('name', 'admin_requests_search_' + Date.now()); } catch{}
        try { el.setAttribute('autocomplete', 'new-password'); } catch{}
        // Also re-randomize name on focus and on user typing, to defeat persistent mappings
        var rerand = function(){ try { el.setAttribute('name', 'admin_requests_search_' + Date.now() + '_' + Math.floor(Math.random()*1e6)); } catch{} };
        el.addEventListener('focus', rerand);
        // Remove automatic rerand on input to prevent unwanted filtering
        // el.addEventListener('input', rerand);
      } catch {}
    })();
  </script>
</body>
</html>
