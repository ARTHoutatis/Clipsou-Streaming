<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Admin – Clipsou Streaming</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" href="../favicon.webp" type="image/webp">
  <link rel="stylesheet" href="admin.css?v=20250910">
  <script>
    // Enforce apex domain online to share localStorage with the main site
    (function(){
      try {
        var h = location.hostname;
        var isLocal = location.protocol === 'file:' || h === 'localhost' || h === '127.0.0.1';
        if (isLocal) return;
        if (h === 'www.clipsoustreaming.com') {
          var target = 'https://clipsoustreaming.com' + location.pathname + location.search + location.hash;
          location.replace(target);
        }
      } catch {}
    })();
  </script>
</head>
<body>
  <main class="container" id="app" hidden>
    <h1>Clipsou Streaming – Admin</h1>

    <section class="auth">
      <p class="muted">Accès restreint. Votre session admin est active.</p>
      <button id="logoutBtn" type="button" class="btn">Se déconnecter</button>
      <a id="homeShortcut" href="../" class="btn secondary" style="margin-left:8px;">Aller à l'accueil</a>
      <button id="superAdminBtn" type="button" class="btn secondary" style="margin-left:8px; background:#ff6b35;">🔐 Super-Admin</button>
    </section>

    <section class="form-section" id="super-admin-section" hidden>
      <h2 style="color:#ff6b35;">🔐 Panneau Super-Admin</h2>
      <p class="muted">Fonctionnalités de sécurité avancées. Accès restreint.</p>
      
      <div style="margin-bottom:24px;">
        <h3>📋 Connexions récentes</h3>
        <div id="loginLogsList" style="max-height:200px; overflow-y:auto; background:#0a1016; padding:12px; border-radius:8px; margin-top:8px;">
          <p class="muted">Chargement...</p>
        </div>
      </div>

      <div style="margin-bottom:24px;">
        <h3>🗑️ Corbeille (7 derniers jours)</h3>
        <div id="trashList" style="max-height:300px; overflow-y:auto; background:#0a1016; padding:12px; border-radius:8px; margin-top:8px;">
          <p class="muted">Chargement...</p>
        </div>
      </div>

      <div class="actions">
        <button id="emergencyPirateBtn" type="button" class="btn" style="background:#dc2626; font-weight:700;">🚨 URGENCE PIRATAGE</button>
        <button id="revokeAllBtn" type="button" class="btn" style="background:#ea580c;">🔴 Révoquer sessions</button>
        <button id="changePasswordBtn" type="button" class="btn secondary">🔑 Changer mot de passe</button>
        <button id="closeSuperAdminBtn" type="button" class="btn secondary">Fermer</button>
      </div>
      
      <div id="emergencyModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.9); z-index:99999; padding:20px; overflow-y:auto;">
        <div style="max-width:600px; margin:40px auto; background:#1a2332; padding:30px; border-radius:12px; border:2px solid #dc2626;">
          <h2 style="color:#dc2626; margin-top:0;">🚨 Procédure d'Urgence Anti-Piratage</h2>
          <div id="emergencyStep1" style="margin:20px 0;">
            <h3>Étape 1/3 : Nouveau mot de passe Admin</h3>
            <p class="muted">Choisissez un nouveau mot de passe fort (min. 12 caractères)</p>
            <input type="text" id="newPasswordInput" placeholder="Nouveau mot de passe admin" style="width:100%; padding:12px; margin:10px 0; font-size:16px; border-radius:8px; border:1px solid #dc2626; background:#0f1720; color:#fff;">
            <button id="generateHashBtn" class="btn" style="background:#dc2626;">Générer le hash →</button>
          </div>
          
          <div id="emergencyStep2" style="display:none; margin:20px 0;">
            <h3>Étape 2/3 : Copier le nouveau hash</h3>
            <p class="muted">Hash SHA-256 de votre nouveau mot de passe :</p>
            <textarea id="newHashDisplay" readonly style="width:100%; padding:12px; margin:10px 0; font-family:monospace; font-size:13px; background:#0a1016; color:#10b981; border:1px solid #10b981; border-radius:8px; height:80px;"></textarea>
            <button id="copyHashBtn" class="btn secondary">📋 Copier le hash</button>
            <p style="margin-top:15px; padding:15px; background:#0a1016; border-left:3px solid #dc2626;">
              <strong>Instructions :</strong><br>
              1. Ouvrez <code style="background:#dc2626; padding:2px 6px; border-radius:4px;">admin/admin.js</code><br>
              2. Cherchez ligne ~36 : <code style="background:#334155; padding:2px 6px; border-radius:4px;">const ADMIN_PASSWORD_HASH =</code><br>
              3. Remplacez le hash par celui ci-dessus<br>
              4. Sauvegardez le fichier
            </p>
            <button id="confirmChangeBtn" class="btn" style="background:#10b981;">✅ J'ai changé le hash dans admin.js</button>
          </div>
          
          <div id="emergencyStep3" style="display:none; margin:20px 0;">
            <h3>Étape 3/3 : Révocation des sessions</h3>
            <p style="color:#10b981; font-weight:600;">✅ Nouveau mot de passe configuré !</p>
            <p class="muted">Toutes les sessions vont maintenant être révoquées. Le pirate ne pourra plus se reconnecter car le mot de passe a changé.</p>
            <button id="finalRevokeBtn" class="btn" style="background:#dc2626; font-size:18px; padding:15px 30px;">🔴 RÉVOQUER TOUTES LES SESSIONS</button>
          </div>
          
          <button id="cancelEmergencyBtn" class="btn secondary" style="margin-top:20px;">Annuler</button>
        </div>
      </div>
    </section>

    <section class="form-section" id="cloudinary-section" hidden>
      <h2 style="display:flex; align-items:center; gap:8px;">
        Stockage images (Cloudinary)
        <button type="button" id="cldLockBtn" class="btn secondary lock-btn" title="Verrouiller/déverrouiller la configuration">🔒</button>
      </h2>
      <p class="muted small">Saisissez votre <strong>Cloud name</strong> et votre <strong>Upload preset</strong> (unsigned) pour activer l’upload en ligne. Ces réglages sont stockés dans votre navigateur.</p>
      <form id="cloudinaryForm">
        <div class="grid">
          <label>
            <span>Cloud name</span>
            <input type="text" id="cldCloudName" placeholder="ex: clipsoucloud" readonly>
          </label>
          <label>
            <span>Upload preset (unsigned)</span>
            <input type="text" id="cldUploadPreset" placeholder="ex: clipsou_unsigned" readonly>
          </label>
          <label>
            <span>Dossier (optionnel)</span>
            <input type="text" id="cldFolder" placeholder="ex: clipsou" readonly>
          </label>
        </div>
        <div class="actions" id="cldActionsRow">
          <button type="button" id="cldSaveBtn" class="btn" disabled>Enregistrer la configuration</button>
          <button type="button" id="cldClearBtn" class="btn secondary" disabled>Réinitialiser</button>
        </div>
        <p id="cldStatus" class="muted small"></p>
      </form>
    </section>

    <section class="form-section">
      <h2>Ajouter / Modifier un contenu</h2>
      <form id="contentForm">
        <input type="hidden" name="id" id="id">
        <input type="hidden" name="requestId" id="requestId">

        <div class="grid">
          <label>
            <span>Titre</span>
            <input type="text" id="title" required>
          </label>
          <label>
            <span>Type</span>
            <select id="type" required>
              <option value="film">Film</option>
              <option value="série">Série</option>
              <option value="trailer">Trailer</option>
            </select>
          </label>
          <label>
            <span>Note (/5)</span>
            <input type="number" id="rating" step="0.5" min="0" max="5">
          </label>
        </div>

        <div class="grid">
          <label>
            <span>Genre 1</span>
            <input type="text" id="genre1" list="genresDatalist" required>
          </label>
          <label>
            <span>Genre 2</span>
            <input type="text" id="genre2" list="genresDatalist" required>
          </label>
          <label>
            <span>Genre 3</span>
            <input type="text" id="genre3" list="genresDatalist" required>
          </label>
        </div>

        <label>
          <span>Description</span>
          <textarea id="description" rows="4" required></textarea>
        </label>

        <div class="grid">
          <label>
            <span>Affiche (format 9/12)</span>
            <input type="hidden" id="portraitImage">
            <div class="actions">
              <label class="btn file-label">
                Importer image
                <input type="file" id="portraitFileInput" accept="image/*" hidden>
              </label>
              <button type="button" id="portraitClearBtn" class="btn secondary">Effacer</button>
            </div>
            <img id="portraitPreview" class="img-preview" alt="Aperçu portrait" hidden>
          </label>
          <label>
            <span>Image fiche (paysage 16/9)</span>
            <input type="hidden" id="landscapeImage">
            <div class="actions">
              <label class="btn file-label">
                Importer image
                <input type="file" id="landscapeFileInput" accept="image/*" hidden>
              </label>
              <button type="button" id="landscapeClearBtn" class="btn secondary">Effacer</button>
            </div>
            <img id="landscapePreview" class="img-preview" alt="Aperçu paysage" hidden>
          </label>
          <label>
            <span>Lien YouTube</span>
            <input type="url" id="watchUrl" placeholder="https://www.youtube.com/..." required>
          </label>
          <label>
            <span>Étiquette studio (image)</span>
            <input type="hidden" id="studioBadge">
            <div class="actions">
              <label class="btn file-label">
                Importer image
                <input type="file" id="studioBadgeFileInput" accept="image/*" hidden>
              </label>
              <button type="button" id="studioBadgeClearBtn" class="btn secondary">Effacer</button>
            </div>
            <img id="studioBadgePreview" class="img-preview" alt="Aperçu étiquette studio" hidden>
          </label>
        </div>

        <fieldset>
          <legend>Acteurs & Doubleurs</legend>
          <div id="actorsList" class="actors-list"></div>
          <div class="actor-row">
            <input type="text" id="actorName" placeholder="Nom" list="actorNamesDatalist">
            <input type="text" id="actorRole" placeholder="Rôle">
            <label class="btn file-label" title="Photo de profil (optionnel)">
              Photo
              <input type="file" id="actorPhotoFile" accept="image/*" hidden>
            </label>
            <img id="actorPhotoPreview" class="img-preview small" alt="Aperçu acteur" hidden>
            <button type="button" id="addActorBtn" class="btn secondary">Ajouter</button>
          </div>
        </fieldset>

        <div class="actions">
          <button type="submit" class="btn">Enregistrer la requête</button>
          <button type="button" id="resetBtn" class="btn secondary">Nouveau</button>
        </div>
      </form>
      <datalist id="genresDatalist"></datalist>
      <datalist id="actorNamesDatalist"></datalist>
    </section>

    <section class="requests">
      <h2>Requêtes d'ajout</h2>
      <form class="search-row" autocomplete="off" onsubmit="return false" role="search" style="display:flex;gap:10px;align-items:center;margin:8px 0 12px 0;flex-wrap:wrap">
        <label for="requestsSearch" class="muted" style="min-width:120px">Recherche</label>
        <input id="requestsSearch" name="admin_requests_search" type="search" placeholder="Rechercher par titre, type, genre, id, acteur…" style="flex:1;min-width:240px;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.15);background:#0f1720;color:#fff;outline:none" autocomplete="off" autocapitalize="none" autocorrect="off" spellcheck="false" enterkeyhint="search" inputmode="search" data-1p-ignore="true" data-lpignore="true" data-bwignore="true">
        <!-- decoy password field to attract Chrome/PM autofill away from the search input -->
        <input type="password" name="password" autocomplete="new-password" tabindex="-1" aria-hidden="true" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;pointer-events:none">
      </form>
      <table class="table" id="requestsTable" aria-describedby="requestsHelp">
        <thead>
          <tr>
            <th>Titre</th>
            <th>Type</th>
            <th>Genres</th>
            <th>Note</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p id="requestsHelp" class="muted">Approuvez une requête pour la publier. Vous pouvez modifier ou supprimer à tout moment.</p>
    </section>
  </main>

  <div id="login" class="login">
    <h1>Admin – Connexion</h1>
    <p class="muted">Entrez le mot de passe admin pour accéder à l’interface.</p>
    <!-- Provide a dedicated username field so Chrome pairs credentials here instead of targeting unrelated inputs -->
    <input id="usernameInput" name="username" type="text" autocomplete="username" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;pointer-events:none" tabindex="-1" aria-hidden="true">
    <!-- Hidden current-password decoy to further attract autofill away from the search field -->
    <input type="password" name="password" autocomplete="current-password" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;pointer-events:none" tabindex="-1" aria-hidden="true">
    <input id="passwordInput" name="admin_password" type="password" placeholder="Mot de passe" autocomplete="current-password" autocapitalize="none" autocorrect="off" spellcheck="false">
    <div style="display:flex; gap:12px; justify-content:center; align-items:center; margin:8px 0;">
      <label style="display:flex; gap:6px; align-items:center;">
        <input id="showPwd" type="checkbox">
        <span>Afficher le mot de passe</span>
      </label>
    </div>
    <button id="loginBtn" class="btn">Se connecter</button>
    <div style="margin-top:8px;">
      <a id="homeShortcutLogin" href="../" class="btn secondary">Retour à l'accueil</a>
    </div>
  </div>

  <script src="admin.js?v=20250928-2" defer></script>
  <script>
    // Extra guard: delay enabling typing in the search box until real user interaction
    (function(){
      try {
        var el = document.getElementById('requestsSearch');
        if (!el) return;
        // Mark readonly to dissuade password managers; remove on first interaction
        el.setAttribute('readonly','readonly');
        var enable = function(){ try { el.removeAttribute('readonly'); } catch{} };
        el.addEventListener('pointerdown', enable, { once: true });
        el.addEventListener('focus', enable, { once: true });
        el.addEventListener('keydown', enable, { once: true });
        // Randomize name and force autocomplete to new-password to avoid PM heuristics
        try { el.setAttribute('name', 'admin_requests_search_' + Date.now()); } catch{}
        try { el.setAttribute('autocomplete', 'new-password'); } catch{}
        // Also re-randomize name on focus and on user typing, to defeat persistent mappings
        var rerand = function(){ try { el.setAttribute('name', 'admin_requests_search_' + Date.now() + '_' + Math.floor(Math.random()*1e6)); } catch{} };
        el.addEventListener('focus', rerand);
        el.addEventListener('input', rerand);
      } catch {}
    })();
  </script>
</body>
</html>
